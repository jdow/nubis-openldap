#!/bin/bash
# During startup we need to elect a "leader" so that that host
# be the ldap sync server for the ldap slave
#
# Script also doubles up as a checker for consul service checks
#set -x

eval $(curl -s -fq http://169.254.169.254/latest/user-data)
INSTANCE_ID=$(curl -s -fq http://169.254.169.254/latest/meta-data/instance-id)
REGION=$(curl -s -fq http://169.254.169.254/latest/dynamic/instance-identity/document | jq '.region' -r)
MY_IP=$(curl -s  -fq http://169.254.169.254/latest/meta-data/local-ipv4)

# Simple logging function
function log() {

    local LOGGER_BIN='/usr/bin/logger'
    local LOGMSG=$1

    [ -z "$LOGMSG" ] && { echo "Usage: $FUNCNAME [log message]"; exit 1; }

    # Set up the logger command if the binary is installed
    if [ ! -x $LOGGER_BIN ]; then
        # If logger is not installed just stderr it out
        echo "$LOGMSG"
    else
        $LOGGER_BIN --stderr --priority local7.info --tag ${BASH_SOURCE} "$LOGMSG"
    fi
}

# This is terrible we need to make sure all of our shit is actually available first
function _is_my_eni_done {

    # Waiting for eni instance to come up
    SUBNET_ID=$(aws ec2 describe-instances --region ${REGION} --instance-ids ${INSTANCE_ID} --query "Reservations[*].Instances[*][SubnetId]" --output text)
    MY_ENI_NAME=$(aws ec2 describe-network-interfaces --region ${REGION} --filter Name=subnet-id,Values=${SUBNET_ID} Name=tag:aws:cloudformation:logical-id,Values=EniAZ* --query 'NetworkInterfaces[*].TagSet[?Key == `aws:cloudformation:logical-id`].Value | [0]' --output text)

    COUNT=0
    # There is now a timeout, try for 20 minutes (aka 20160 seconds more or less is 20 minutes)
    until [[ ! -z "${AM_I_DONE}" ]] || [[ "${COUNT}" == "20160" ]]; do
        AM_I_DONE=$(aws cloudformation describe-stack-resources --region ${REGION} --stack-name ${NUBIS_STACK} --query 'StackResources[*][LogicalResourceId, ResourceStatus]' --output text | grep ${MY_ENI_NAME} | egrep -q 'CREATE_COMPLETE')
        sleep 10
        COUNT=${COUNT}+1
    done

}

# Whats my ENI IP?
if [[ -f /var/tmp/eni_ip ]] && [[ -s /var/tmp/eni_ip ]]; then
    ENI_IP=$(cat /var/tmp/eni_ip)
else
    # Stuff we need to attach ENI
    #SUBNET_ID=$(aws ec2 describe-instances --region ${EC2_REGION} --instance-ids ${INSTANCE_ID} --query "Reservations[*].Instances[*][SubnetId]" --output text)
    #ATTACHING_ENI=$(aws ec2 describe-network-interfaces  --region ${EC2_REGION} --filter Name=tag-key,Values=StackName Name=tag-value,Values=${NUBIS_STACK} --query "NetworkInterfaces[?Status == \`available\`][NetworkInterfaceId, SubnetId]" --output text | grep ${SUBNET_ID} | awk '{print $1}')
    #ENI_IP=$(aws ec2 describe-network-interfaces --region ${EC2_REGION}  --filter --filter Name=network-interface-id,Values=${ATTACHING_ENI} --query "NetworkInterfaces[*].PrivateIpAddress" --output text)

    # Waiting for eni instance to come up
    #_is_my_eni_done
    ENI_IP=$(aws ec2 describe-instances --instance-id ${INSTANCE_ID} --region ${REGION} --query "Reservations[*].Instances[*].NetworkInterfaces[*].PrivateIpAddresses[*].PrivateIpAddress" --output text | grep -v ${MY_IP})
    echo ${ENI_IP} > /var/tmp/eni_ip
fi

if [[ "$1" == "check" ]]; then
    # we don't really care about if this check passes or not really,
    # we're really only doing this so that we can make the check pass and
    # so that we can have consul actually re-run consul-do to get a new lock. Yes its a cheat i know
    /usr/local/bin/consul-do ${NUBIS_STACK}/${NUBIS_ENVIRONMENT} ${ENI_IP} DEBUG || exit 0
else
    /usr/local/bin/consul-do ${NUBIS_STACK}/${NUBIS_ENVIRONMENT} ${ENI_IP} || exit
    log "Electing ${INSTANCE_ID} with ENI IP ${ENI_IP} as leader and creating a lock"
fi
